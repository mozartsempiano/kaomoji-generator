<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="Make your custom Kaomoji or select a premade one!" />
		<meta name="keywords" content="kaomoji, japanese, emoticons, emojis" />

		<title>(*‚âß‚àÄ‚â¶*) Kaomoji Generator - Japanese Emoticons</title>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

		<link rel="stylesheet" href="/assets/css/kaomoji.css" />

		<style id="notification-style">
			#copy-notification {
				position: fixed;
				bottom: 20px;
				right: 20px;
				background: rgba(50, 50, 50, 0.9);
				color: var(--clr-text);
				padding: 10px 16px;
				border-radius: 6px;
				font-family: var(--fonte);
				font-size: 1em;
				opacity: 0;
				pointer-events: none;
				transition: opacity 0.3s ease, transform 0.3s ease;
				transform: translateY(20px);
				z-index: 1000;
			}

			#copy-notification.show {
				opacity: 1;
				transform: translateY(0);
			}

			#copy-notification.notifError {
				background: var(--clr-red-a40);
				color: var(--clr-white-k);
			}

			#copy-notification.notifSuccess {
				background: var(--clr-green-a30);
				color: var(--clr-black-a0);
			}

			/* Preloader Styles */
			#preloader {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: var(--clr-background);
				display: flex;
				justify-content: center;
				align-items: center;
				z-index: 9999;
				transition: opacity 0.5s ease, visibility 0.5s ease;
			}

			#preloader.hidden {
				opacity: 0;
				visibility: hidden;
			}

			.loader {
				display: flex;
				flex-direction: column;
				align-items: center;
				gap: 21px;
			}

			.loader-kaomoji {
				font-size: 2rem;
				animation: bounce 1.5s ease-in-out infinite;
				color: var(--clr-text);
			}

			.loader-text {
				color: var(--clr-text);
				font-family: var(--fonte);
				font-size: 1rem;
				opacity: 0.8;
			}

			.loader-spinner {
				width: 32px;
				height: 32px;
				border: 3px solid var(--clr-gray-k);
				border-top: 3px solid var(--clr-text);
				border-radius: 50%;
				animation: spin 1s linear infinite;
			}

			@keyframes bounce {
				0%,
				20%,
				50%,
				80%,
				100% {
					transform: translateY(0);
				}
				40% {
					transform: translateY(-10px);
				}
				60% {
					transform: translateY(-5px);
				}
			}

			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}
		</style>
	</head>

	<body>
		<!-- Preloader -->
		<div id="preloader">
			<div class="loader">
				<div class="loader-kaomoji">d(„ÄÉ‚âßœâ‚â¶„ÄÉ)b</div>
				<div class="loader-text">Loading...</div>
				<div class="loader-spinner"></div>
			</div>
		</div>

		<div id="container-kaomoji" class="fade-in">
			<div id="content">
				<div id="left-col">
					<div id="title">
						<h1>Kaomoji</h1>
						<h1 style="font-size: clamp(2rem, 6em, 6em)">È°îÊñáÂ≠ó</h1>
						<h2 class="subtitle">Japanese Emoticons</h2>
					</div>

					<div id="filters">
						<button id="btn-filter" aria-haspopup="dialog" aria-expanded="false" aria-controls="popup-filters" type="button">
							<span class="typography-title-sm">Filter</span>
							<svg viewBox="0 0 24 24" role="presentation" aria-hidden="true">
								<path d="M7.41,15.41L12,10.83L16.59,15.41L18,14L12,8L6,14L7.41,15.41Z" style="fill: currentColor"></path>
							</svg>
						</button>

						<button id="btn-clear" type="button" aria-disabled="true" disabled>Clear filters</button>

						<div id="popup-filters" role="region" aria-hidden="true" aria-labelledby="btn-filter" hidden>
							<div id="popup-filters-list" data-e2eid="category-filter"></div>
						</div>
					</div>

					<img src="/assets/img/halftone.png" class="tilt2" />
				</div>
				<div id="right-col">
					<div id="kaomoji-generator">
						<h2>Kaomoji Generator</h2>
						<div id="generator-inputs"></div>
						<div id="kaomoji-preview">
							<pre title="Click to copy"></pre>
							<button id="generate-random">Random</button>
							<!-- <button id="copy-generated">Copy Kaomoji</button> -->
						</div>
					</div>

					<div id="kaomoji-list"></div>
				</div>
			</div>

			<div id="copy-notification"></div>

			<footer>¬©2025 <a href="https://mozartsempiano.com/">mozartsempiano</a> / <a href="https://mozartsempiano.com/doar">Donate</a></footer>
		</div>

		<script type="module" src="/assets/js/kaomoji.js"></script>
		<script>
			const kaomojis = [
				{ text: "(Ôºæ‚ñΩÔºæ)", tags: ["joy"] },
				{ text: "(‚ïØ¬∞‚ñ°¬∞)‚ïØÔ∏µ ‚îª‚îÅ‚îª", tags: ["anger"] },
				{ text: "(¬¨‚Äø¬¨)", tags: ["cool", "smugness"] },
				{ text: "(‚úø‚ó†‚Äø‚ó†)", tags: ["joy"] },
				{ text: "(‡≤•Ôπè‡≤•)", tags: ["sadness"] },
				{ text: "‡´Æ ‚óû Ôªå ‚óü ·Éê", tags: ["sadness", "dogs", "animals"] },
				{ text: "( Õ°¬∞ Õú ñ Õ°¬∞)", tags: ["smugness"] },
				{ text: "ÍâÇ(ÀµÀÉ ·óú ÀÇÀµ)", tags: ["joy"] },
				{ text: "(À∂·µî ·µï ·µîÀ∂)", tags: ["joy"] },
				{ text: "(‚ï•Ôπè‚ï•)", tags: ["sadness"] },
				{ text: "‡¥¶‡µç‡¥¶‡¥ø ÀâÕàÃÄÍí≥ÀâÕàÃÅ )‚úß", tags: ["joy", "agree"] },
				{ text: "(À∂ÀÉ ·µï ÀÇÀ∂)", tags: ["joy"] },
				{ text: "‚óù(·µî·óú·µî)‚óú", tags: ["joy"] },
				{ text: "‚ô°‚∏ú(ÀÉ ·µï ÀÇ )‚∏ù", tags: ["love"] },
				{ text: "‡¥¶‡µç‡¥¶‡¥ø(·µî·óú·µî)", tags: ["joy", "agree"] },
				{ text: "·ïô(  ‚Ä¢ÃÄ ·óú ‚Ä¢ÃÅ  )·ïó", tags: ["smugness"] },
				{ text: "(À∂ÀÜÍí≥ÀÜÀµ)", tags: ["joy"] },
				{ text: "(¬¨_¬¨')", tags: ["dissatisfaction"] },
				{ text: "‡´ÆÍí∞À∂·µî ·µï ·µîÀ∂Íí±·Éê", tags: ["joy", "sheep", "animals"] },
				{ text: "( ‚âß·óú‚â¶)", tags: ["joy"] },
				{ text: "( ÀòÕà ·µï ÀòÕà‚ô°)", tags: ["love"] },
				{ text: "‚àò ‚àò ‚àò ( ¬∞„ÉÆ¬∞ ) ?", tags: ["confusion"] },
				{ text: "(¬¥ÔΩ°‚Ä¢ ·µï ‚Ä¢ÔΩ°`)", tags: ["joy"] },
				{ text: "(¬¥ÔΩ•_ÔΩ•`)", tags: ["sadness", "confusion"] },
				{ text: "(¬¥‚ñΩ` É‚ô°∆™)", tags: ["love"] },
				{ text: "(‚úßœâ‚úß)", tags: ["joy"] },
				{ text: "(o¬¥‚àÄ`o)", tags: ["joy"] },
				{ text: "(oT-T)Â∞∏", tags: ["sadness"] },
				{ text: "‡´Æ‚Çç ÀÉ ‚§ô ÀÇ ‚Çé·Éê", tags: ["dissatisfaction", "dogs", "animals"] },
				{ text: "; (‚óû‚Ä∏‚óü)", tags: ["sadness", "dissatisfaction"] },
				{ text: "( ‚à©¬¥Õà ·êú `Õà‚à©)", tags: ["embarrassment"] },
				{ text: "(‚äô _ ‚äô )", tags: ["surprise"] },
				{ text: "''( ‚Äì ‚åì ‚Äì )", tags: ["confusion", "indifference"] },
				{ text: "( Àò ¬≥Àò )‚ô°", tags: ["love", "kiss"] },
				{ text: "( ‚Ä¢ ·¥ó - ) ‚úß", tags: ["wink"] },
				{ text: "(À∂Àò ¬≥Àò(¬¥Õà ·µï `ÕàÀ∂)", tags: ["love", "kiss"] },
				{ text: "‚∏ú(‚∏ù‚∏ù‚∏ù¬¥Íí≥`‚∏ù‚∏ù‚∏ù)‚∏ù", tags: ["joy"] },
				{ text: "o(‚âß‚ñΩ‚â¶)o", tags: ["joy"] },
				{ text: "(*‚âßœâ‚â¶*)", tags: ["joy"] },
				{ text: "(‚ÅÄ·ó¢‚ÅÄ)", tags: ["joy"] },
				{ text: "o(>œâ<)o", tags: ["joy"] },
				{ text: "(‚âß‚ó°‚â¶) ‚ô°", tags: ["love"] },
				{ text: "Œ£>‚Äï(„ÄÉ¬∞œâ¬∞„ÄÉ)‚ô°‚Üí", tags: ["love"] },
				{ text: "(‚ÅÑ ‚ÅÑ>‚ÅÑ ‚ñΩ ‚ÅÑ<‚ÅÑ ‚ÅÑ)", tags: ["embarrassment"] },
				{ text: "(„Å£¬¥œâ`)Ôæâ(‚ï•œâ‚ï•)", tags: ["compassion"] },
				{ text: "(·óí·ó£·óï)’û", tags: ["dissatisfaction"] },
				{ text: "(ÔºûÔΩçÔºú)", tags: ["dissatisfaction"] },
				{ text: "(Ôæâ‡≤•Áõä‡≤•)Ôæâ", tags: ["anger"] },
				{ text: "‡≠ß((#Œ¶ÁõäŒ¶#))‡≠®", tags: ["anger"] },
				{ text: "Ÿ©(‡∞†Áõä‡∞†)€∂", tags: ["anger"] },
				{ text: "( ; œâ ; )", tags: ["sadness"] },
				{ text: "(ÔΩ°T œâ TÔΩ°)", tags: ["sadness"] },
				{ text: "(‚ï•Ôπè‚ï•)", tags: ["sadness"] },
				{ text: "(‚ï•_‚ï•)", tags: ["sadness"] },
				{ text: ".¬∑¬∞’û(·óí·ó£·óï)’û¬∞¬∑.", tags: ["sadness"] },
				{ text: "(‚ïØÔ∏µ‚ï∞,)", tags: ["sadness"] },
				{ text: "q(‚ï•Ôπè‚ï•)p", tags: ["sadness"] },
				{ text: "o(T„ÉòTo)", tags: ["sadness"] },
				{ text: "(ÔΩ°‚ïØÔ∏µ‚ï∞ÔΩ°)", tags: ["sadness"] },
				{ text: "(√óÔπè√ó)‚åí‚òÜ", tags: ["pain"] },
				{ text: "(À∂¬∞„ÖÅ¬∞)!!", tags: ["surprise", "fear"] },
				{ text: "Œ£(¬∞„É≠¬∞)!!!", tags: ["surprise", "fear"] },
				{ text: "‚àë(O_O;)", tags: ["surprise"] },
				{ text: "‚ñì‚ñí‚ñë(¬∞‚ó°¬∞)‚ñë‚ñí‚ñì", tags: ["fear"] },
				{ text: "(Ôø£‚ñΩÔø£)„Éé", tags: ["wave"] },
				{ text: "„Éæ(‚òÜ‚ñΩ‚òÜ)", tags: ["wave"] },
				{ text: "( ‚ó°‚Äø‚ó° )", tags: ["joy"] },
				{ text: "(‚óûÔ∏µ‚óü)", tags: ["sadness"] },
				{ text: "(‚ï¨‡≤†Áõä‡≤†)", tags: ["anger"] },
				{ text: " ï‚óâ·¥•‚óâ î", tags: ["bears", "animals"] },
				{ text: " ï‚âß„â®‚â¶ î", tags: ["bears", "animals"] },
				{ text: "(*‚âß‚àÄ‚â¶*)", tags: ["joy"] },
				{ text: "(*¬¥œâ ` *)", tags: ["joy"] },
				{ text: "^‚ÜÄ·¥•‚ÜÄ^", tags: ["cats", "animals"] },
				{ text: "(=‚ÜÄœâ‚ÜÄ=)", tags: ["cats", "animals"] },
				{ text: "(‚îÄ‚Äø‚Äø‚îÄ)", tags: ["joy", "silly"] },
				{ text: "Ôºº(Ôºæ‚ñΩÔºæ)Ôºè", tags: ["joy"] },
				{ text: "(Àò‚àÄÀò)/(Œº‚ÄøŒº) ‚ù§", tags: ["love"] },
				{ text: "(‚ù§œâ‚ù§)", tags: ["love"] },
				{ text: "‚ô°( ‚ó°‚Äø‚ó° )", tags: ["love"] },
				{ text: "(¬¥,,‚Ä¢œâ‚Ä¢,,)‚ô°", tags: ["love"] },
				{ text: "(‚ÅÑ ‚ÅÑ‚Ä¢‚ÅÑœâ‚ÅÑ‚Ä¢‚ÅÑ ‚ÅÑ)", tags: ["embarrassment"] },
				{ text: "(‚Äû‡≤°œâ‡≤°‚Äû)", tags: ["embarrassment", "silly"] },
				{ text: "(„Éé*¬∞‚ñΩ¬∞*)", tags: ["embarrassment"] },
				{ text: "œÅ(- œâ -„ÄÅ)„Éæ(Ôø£œâÔø£; )", tags: ["compassion"] },
				{ text: "„ÉΩ(Ôø£œâÔø£(„ÄÇ„ÄÇ )„Çù", tags: ["compassion"] },
				{ text: "Âá∏(Ôø£„ÉòÔø£)", tags: ["dissatisfaction"] },
				{ text: "(Ôø£ Ôø£|||)", tags: ["dissatisfaction"] },
				{ text: "(Ôø£Ô∏øÔø£)", tags: ["indifference"] },
				{ text: "(‚áÄ‚Ä∏‚Üº‚Ä∂)", tags: ["dissatisfaction"] },
				{ text: "„ÄÇ„Çú„Çú(¬¥ÔºØ`) „Çú„Çú„ÄÇ", tags: ["sadness"] },
				{ text: "ÔºàÔΩâ–îÔΩâÔºâ", tags: ["sadness"] },
				{ text: "( Àò‚ñΩÀò)„Å£‚ô®", tags: ["food"] },
				{ text: "(„ÄÄ¬¥‚àÄ`)„Å§‚Äï‚óè‚óã‚óé-", tags: ["food"] },
				{ text: "‡´Æ‚Çç ¬¥À∂‚Ä¢ ·¥• ‚Ä¢À∂‚Çé·Éê", tags: ["dogs", "animals"] },
				{ text: "‡´Æ‚Çç À∂·µî ·µï ·µîÀ∂ ‚Çé·Éê", tags: ["joy", "dogs", "animals"] },
				{ text: "(‚∏ù‚∏ù ‚óú~‚óù ‚∏ù‚∏ù)", tags: ["embarrassment"] },
				{ text: "(,,·¥ó ¬†Ã´·¥ó,,)Íï§*.Ôæü", tags: ["embarrassment"] },
				{ text: "( ‡©≠ Àô·óúÀô )‡©≠", tags: ["joy"] },
				{ text: "(‚óè¬¥œñ`‚óè)", tags: ["silly"] },
				{ text: "o(„ÄÉÔºæ‚ñΩÔºæ„ÄÉ)o", tags: ["joy"] },
				{ text: "o(‚∏ù‚∏ù¬∫·óú¬∫‚∏ù‚∏ù)>‚ô°", tags: ["love"] },
				{ text: "¬Ø\\_(·êõ )_/¬Ø", tags: ["silly"] },
				{ text: "‚ô°(‚óç‚Ä¢„ÖÖ‚Ä¢‚óç)‚ô°", tags: ["love"] },
				{ text: "‚âΩ^‚Ä¢‚©ä‚Ä¢^‚âº", tags: ["cats", "animals"] },
				{ text: "‚âΩ^À∂‚à©‚©ä‚à©À∂^‚âº", tags: ["embarrassment", "cats", "animals"] },
				{ text: "/·ê†‚Ä¢ Àï ‚Ä¢„Éû", tags: ["cats", "animals"] },
				{ text: "(·ìÄ‚Ä∏·ìÇ)", tags: ["anger"] },
				{ text: "( = ‚©ä = )", tags: ["embarrassment"] },
				{ text: "(‡πë>‚ó°<‡πë)", tags: ["embarrassment", "joy"] },
				{ text: "(·óí‚©ä·óï)", tags: ["embarrassment", "joy"] },
				{ text: "(0Ôºæ„ÉºÔºæ0Ôºâ", tags: ["joy"] },
				{ text: "(‡≤• Õú ñ‡≤•)", tags: ["sadness", "silly"] },
				{ text: "(‚ï¨Ôø£ÁöøÔø£)", tags: ["anger"] },
				{ text: "(@‚Äôœâ‚Äô@)", tags: ["embarrassment"] },
				{ text: "Ÿ©(‡πõ Àò ¬≥Àò)€∂‚ù§", tags: ["love"] },
				{ text: "(=^ÔΩ•œâÔΩ•^=)", tags: ["cats", "animals"] },
				{ text: " ï ‚Äì ·¥• ‚Äì  î", tags: ["cool", "bears", "animals"] },
				{ text: " ï Íàç·¥•Íàç î", tags: ["bears", "animals"] },
				{ text: "( Õ°¬∞ ·¥• Õ°¬∞  ã)", tags: ["dogs", "animals"] },
				{ text: "œÖ¬¥‚Ä¢ Ôªå ‚Ä¢`œÖ", tags: ["dogs", "animals"] },
				{ text: "‡´Æ ÍàçÔªå Íàç·Éê‚ô•(Àò ŒµÀò U)", tags: ["love", "dogs", "animals"] },
				{ text: "( ‚öÜ_‚öÜ )?", tags: ["confusion"] },
				{ text: "(ÔΩ°‚Ä¢ . ‚Ä¢ÔΩ°)??", tags: ["confusion"] },
				{ text: "(ÔºõÔø£–îÔø£)Ôºü", tags: ["confusion"] },
				/*{
          text: `.           .üå∑üå∏üå∑üå∏
          üå∏üå∑üå∏üå∑üå∏
        Œõ üå∑üå∏üå∑üå∏üå∑
      ( Àò ·µï Àò  üå∑üå∏üå∑
       „ÉΩ  „Å§Ôºº     Ôºè
          UU   / üéÄ \\`,
          tags: ["multiple lines", "flowers", "cute"],
        },*/
			];

			let sortOrder = "desc"; // "asc" or "desc"

			const list = document.getElementById("kaomoji-list");
			const filtersContainer = document.getElementById("filters");

			/* const allTags = ["All", ...new Set(kaomojis.flatMap((k) => k.tags))]; */
			const allTags = ["All", ...Array.from(new Set(kaomojis.flatMap((k) => k.tags))).sort((a, b) => a.localeCompare(b))];

			const activeFilters = new Set();

			// Updates URL according to active filters
			function updateURL() {
				if (activeFilters.size === 0) {
					history.replaceState(null, "", window.location.pathname);
				} else {
					const tagsParam = Array.from(activeFilters).join(",");
					history.replaceState(null, "", `?tags=${encodeURIComponent(tagsParam)}`);
				}
			}

			// Initializes filters from URL
			function loadFiltersFromURL() {
				const params = new URLSearchParams(window.location.search);
				const tagsParam = params.get("tags");
				if (tagsParam) {
					tagsParam.split(",").forEach((tag) => {
						if (allTags.includes(tag)) activeFilters.add(tag);
					});
				}
			}

			// Updates the kaomoji list and button/tag classes
			function updateFilters() {
				const filtered = activeFilters.size === 0 ? kaomojis : kaomojis.filter((k) => Array.from(activeFilters).every((f) => k.tags.includes(f)));

				renderKaomojis(filtered);

				// Updates top buttons
				filtersContainer.querySelectorAll("button").forEach((btn) => {
					const tag = btn.textContent;
					btn.classList.toggle("selected", activeFilters.has(tag));
				});

				// enable/disable the clear button under Filter
				if (btnClear) {
					if (activeFilters.size > 0) {
						btnClear.removeAttribute("disabled");
						btnClear.setAttribute("aria-disabled", "false");
					} else {
						btnClear.setAttribute("disabled", "true");
						btnClear.setAttribute("aria-disabled", "true");
					}
				}

				updateURL();
				// also refresh popup tag selected state if present
				if (typeof renderPopupTags === "function") renderPopupTags();
			}

			// Build a compact filter UI: a single "Filter" button that opens a popup with all tags
			const btnFilter = document.getElementById("btn-filter");
			const popupFilters = document.getElementById("popup-filters");
			const popupList = document.getElementById("popup-filters-list");
			const btnClear = document.getElementById("btn-clear");

			function openPopup() {
				popupFilters.hidden = false;
				popupFilters.setAttribute("aria-hidden", "false");
				popupFilters.setAttribute("aria-modal", "true");
				btnFilter.setAttribute("aria-expanded", "true");
				// focus first interactive element (the first checkbox row)
				const firstRow = popupList.querySelector("[role='checkbox']");
				if (firstRow) firstRow.focus();
			}

			function closePopup() {
				popupFilters.hidden = true;
				popupFilters.setAttribute("aria-hidden", "true");
				popupFilters.removeAttribute("aria-modal");
				btnFilter.setAttribute("aria-expanded", "false");
				btnFilter.focus();
			}

			btnFilter.addEventListener("click", (e) => {
				if (popupFilters.hidden) openPopup();
				else closePopup();
			});

			if (btnClear) {
				btnClear.addEventListener("click", () => {
					if (activeFilters.size === 0) return; // no-op when disabled
					activeFilters.clear();
					updateFilters();
					// keep popup open and focus first row
					const firstRow = popupList.querySelector("[role='checkbox']");
					if (firstRow) firstRow.focus();
				});
			}

			// close popup on ESC
			document.addEventListener("keydown", (e) => {
				if (e.key === "Escape" && !popupFilters.hidden) closePopup();
			});

			// close popup when clicking outside of it but ignore clicks on the filter and clear buttons
			document.addEventListener("click", (e) => {
				if (popupFilters.hidden) return;
				const target = e.target;
				if (popupFilters.contains(target)) return; // inside popup
				if (btnFilter && (btnFilter === target || btnFilter.contains(target))) return; // clicked Filter
				if (btnClear && (btnClear === target || btnClear.contains(target))) return; // clicked clear
				// otherwise close
				closePopup();
			});

			// Basic focus trap: keep Tab/Shift+Tab within popup when open
			document.addEventListener("keydown", (e) => {
				if (e.key !== "Tab") return;
				if (popupFilters.hidden) return;

				const focusable = popupFilters.querySelectorAll("[role='checkbox'], button:not([disabled])");
				if (!focusable.length) return;
				const first = focusable[0];
				const last = focusable[focusable.length - 1];

				if (e.shiftKey) {
					if (document.activeElement === first) {
						e.preventDefault();
						last.focus();
					}
				} else {
					if (document.activeElement === last) {
						e.preventDefault();
						first.focus();
					}
				}
			});

			// Render popup as a list of checkbox-like rows with counts
			function renderPopupTags() {
				popupList.innerHTML = "";

				// compute counts per tag
				const counts = {};
				allTags.forEach((t) => (counts[t] = 0));
				kaomojis.forEach((k) =>
					k.tags.forEach((t) => {
						if (counts[t] !== undefined) counts[t]++;
					})
				);

				allTags.forEach((tag) => {
					const row = document.createElement("div");
					row.className = "popup-item";
					row.tabIndex = 0;
					// treat "All" specially by showing total
					const isAll = tag === "All";
					const checked = isAll ? activeFilters.size === 0 : activeFilters.has(tag);
					row.setAttribute("role", "checkbox");
					row.setAttribute("aria-checked", checked ? "true" : "false");

					// checkbox square
					const cb = document.createElement("span");
					cb.className = "popup-checkbox";
					cb.innerHTML = `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg>`;

					const label = document.createElement("span");
					label.className = "popup-label";
					label.textContent = tag;

					const countSpan = document.createElement("span");
					countSpan.className = "popup-count";
					countSpan.textContent = isAll ? `(${kaomojis.length})` : `(${counts[tag] || 0})`;

					row.appendChild(cb);
					row.appendChild(label);
					row.appendChild(countSpan);

					// click/keyboard toggles
					function toggle() {
						if (isAll) {
							activeFilters.clear();
						} else {
							if (activeFilters.has(tag)) activeFilters.delete(tag);
							else activeFilters.add(tag);
						}
						updateFilters();
						// re-render rows to update aria-checked and counts
						renderPopupTags();
					}

					row.addEventListener("click", (e) => {
						// prevent the click from bubbling to document: we re-render the popup synchronously
						// which may remove the original target from the DOM and cause the global
						// outside-click handler to close the popup. Stopping propagation here prevents that.
						e.stopPropagation();
						toggle();
					});

					row.addEventListener("keydown", (e) => {
						if (e.key === " " || e.key === "Enter") {
							e.preventDefault();
							e.stopPropagation();
							toggle();
						}
						if (e.key === "Escape") {
							e.stopPropagation();
							closePopup();
						}
					});

					popupList.appendChild(row);
				});
			}

			renderPopupTags();

			// Notification text constants
			const NOTIFICATION_TEXTS = {
				SUCCESS: "Copied! ‡¥¶‡µç‡¥¶‡¥ø ÀâÕàÃÄÍí≥ÀâÕàÃÅ )‚úß",
				ERROR: "Error copying! Œ£(¬∞„É≠¬∞)!!!",
			};

			// Renders kaomojis and tags below each one
			function renderKaomojis(filteredList) {
				list.innerHTML = "";

				// Gets the notification div (or creates if it doesn't exist)
				let copyNotification = document.getElementById("copy-notification");
				if (!copyNotification) {
					copyNotification = document.createElement("div");
					copyNotification.id = "copy-notification";
					copyNotification.textContent = NOTIFICATION_TEXTS.SUCCESS;
					document.body.appendChild(copyNotification);
				}

				const timeout = 3000; // notification duration
				let copyTimeout; // controls current timeout

				// --- applies global sorting ---
				let sorted = [...filteredList];
				if (sortOrder === "desc") sorted.reverse();

				sorted.forEach((k) => {
					const container = document.createElement("div");
					container.classList.add("kaomoji-item");

					const pre = document.createElement("pre");
					pre.textContent = k.text;
					pre.style.cursor = "pointer";

					container.appendChild(pre);

					const tagsDiv = document.createElement("div");
					tagsDiv.classList.add("tags");

					k.tags.forEach((t) => {
						const span = document.createElement("span");
						span.textContent = t;
						span.style.cursor = "pointer";
						span.style.marginRight = "6px";

						span.addEventListener("click", () => {
							activeFilters.has(t) ? activeFilters.delete(t) : activeFilters.add(t);
							updateFilters();
						});

						span.classList.toggle("selected", activeFilters.has(t));
						tagsDiv.appendChild(span);
					});

					container.appendChild(tagsDiv);
					list.appendChild(container);
				});

				// --- Delegation: ensures it works for dynamic <pre> elements ---
				const root = document.getElementById("container-kaomoji");
				if (root && !root.dataset.clipboardInit) {
					root.addEventListener("click", async (e) => {
						const pre = e.target.closest("pre");
						if (!pre || !root.contains(pre)) return;

						const textToCopy = pre.textContent;

						// clears previous timeout
						if (copyTimeout) clearTimeout(copyTimeout);

						// Reset notification classes
						copyNotification.className = "";

						try {
							await navigator.clipboard.writeText(textToCopy);
							copyNotification.textContent = NOTIFICATION_TEXTS.SUCCESS;
							copyNotification.classList.add("show", "notifSuccess");
							playCopySuccess(); // Plays success sound
						} catch (err) {
							console.error("Error copying (clipboard.writeText):", err);

							// old fallback
							try {
								const textarea = document.createElement("textarea");
								textarea.value = textToCopy;
								textarea.setAttribute("readonly", "");
								textarea.style.position = "absolute";
								textarea.style.left = "-9999px";
								document.body.appendChild(textarea);

								textarea.select();
								textarea.setSelectionRange(0, textarea.value.length);

								const successful = document.execCommand("copy");
								document.body.removeChild(textarea);

								if (successful) {
									copyNotification.textContent = NOTIFICATION_TEXTS.SUCCESS;
									copyNotification.classList.add("show", "notifSuccess");
									playCopySuccess(); // Plays success sound in fallback too
								} else {
									copyNotification.textContent = NOTIFICATION_TEXTS.ERROR;
									copyNotification.classList.add("show", "notifError");
									playCopyFail(); // Plays error sound in fallback
								}
							} catch (err2) {
								console.error("Fallback failed:", err2);
								copyNotification.textContent = NOTIFICATION_TEXTS.ERROR;
								copyNotification.classList.add("show", "notifError");
								playCopyFail(); // Plays error sound when everything fails
							}
						}

						// restarts timeout
						copyTimeout = setTimeout(() => {
							copyNotification.classList.remove("show", "notifSuccess", "notifError");
							copyTimeout = null;
						}, timeout);
					});

					root.dataset.clipboardInit = "1";
				}
			}

			loadFiltersFromURL();
			updateFilters();
		</script>

		<script>
			// === KAOMOJI GENERATOR ===

			const options = {
				extraLeft: ["", "‚úß", "‚àò ‚àò ‚àò", "ÍâÇ", "?", "''", "Œ£>‚Äï", "!!!", "Œ£", "‚òÜ‚åí", ".¬∑¬∞’û", "‚ô° ", ".Ôæü*Íï§"],
				armLeft: ["", "„ÉΩ", "‚óù", "‚ï≠", "o", "‰πÅ", "q", "‡≠ß", "·ïô", "‡¥¶‡µç‡¥¶‡¥ø", "d", "„Éæ", "‚∏ú", "Âá∏", " ö"],
				faceLeft: ["", "(", "((", "(*", "(À∂", "(‚ô°", "(¬¥ÔΩ°", "(¬¥", "(o", "(‚óç", "‡´Æ ", "‡´Æ‚Çç ", "‡´ÆÍí∞", " ï", "(#", "(=", "(‚∏ù‚∏ù ", "(‚Äû", "(„ÄÉ", "‡ºº "],
				eyeLeft: [
					"^",
					"‚ó†",
					"·µî",
					"ÀÜ",
					"ÀòÕà",
					"ÀâÕàÃÄ",
					"Ôø£",
					">",
					"Ôºû",
					"·óí",
					"‚âß",
					"¬∞",
					"‚Ä¢",
					"‚Ä¢ÃÄ",
					"ÔΩ•",
					"¬¨",
					"‚Äì",
					"‚äô",
					"O",
					"‡≤†",
					"‡≤•",
					"‡∞†",
					"‚óû",
					"‚ïØ",
					"¬¥",
					"T",
					"‚ï•",
					";",
					"ÔΩâ",
					"Œ¶",
					"‚ÜÄ",
					"‚òÜ",
					"‚úß",
					"√ó",
					" Õ°¬∞",
					"Íàç",
					"‚ô•",
					"‚ô°",
					"·ëå",
					"Ôº†",
					"Õ°U",
					"√≤",
					"‚ãã",
					"·ìÄ",
					"‡∂ß",
				],
				mouth: [
					"‚Äø",
					"·µï",
					"·¥ó",
					"‚ó°",
					"ÔΩñ",
					"Íí≥",
					"œâ",
					"‚Äø‚Äø",
					"‚ñΩ",
					"·óú",
					"·ó¢",
					"„ÉÆ",
					"‚àÄ",
					"–∑",
					"3",
					"¬≥",
					"·ìÄ",
					"Ô∏µ",
					"Ô∏ø",
					"„Éò",
					"‚Ä∏",
					"„ÖÖ",
					"‚åì",
					"·ó£",
					"Œî",
					"_",
					"-",
					"Ôπè",
					"m",
					"√ó",
					"‚§ô",
					"o",
					"‚ñ°",
					"„É≠",
					"–î",
					"Áõä",
					" Õú ñ",
					"œñ",
					"·¥•",
					"‹´",
					"(ÔΩ™)",
					"„â®",
				],
				eyeRight: [
					"^",
					"‚ó†",
					"·µî",
					"ÀÜ",
					"ÀòÕà",
					"ÀâÕàÃÅ",
					"Ôø£",
					"<",
					"Ôºú",
					"·óï",
					"‚â¶",
					"¬∞",
					"‚Ä¢",
					"‚Ä¢ÃÅ",
					"ÔΩ•",
					"¬¨",
					"‚Äì",
					"‚äô",
					"O",
					"‡≤†",
					"‡≤•",
					"‡∞†",
					"‚óü",
					"‚ï∞",
					"`",
					"T",
					"‚ï•",
					";",
					"ÔΩâ",
					"Œ¶",
					"‚ÜÄ",
					"‚òÜ",
					"‚úß",
					"√ó",
					" Õ°¬∞",
					"Íàç",
					"‚ô•",
					"‚ô°",
					"·ëå",
					"Ôº†",
					"Õ°U",
					"√≥",
					"‚ãå",
					"·ìÇ",
					"‡∂ß",
				],
				faceRight: ["", ")", "))", "*)", "À∂)", "‚ô°)", "ÔΩ°`)", "`)", "o)", "‚óç)", " ·Éê", " ‚Çé·Éê", "Íí±·Éê", " î", "#)", "=)", " ‚∏ù‚∏ù)", "‚Äû)", "„ÄÉ)", " ‡ºΩ"],
				armRight: ["", "Ôæâ", "‚óú", "‚ïÆ", "o", "„Ñè", "p", "‡≠®", "·ïó", "‡¥¶‡µç‡¥¶‡¥ø", "b", "„Éæ", "‚∏ù", "Âá∏", "…û"],
				extraRight: ["", "‚úß", "‚àò ‚àò ‚àò", "ÍâÇ", "?", "''", "‚ô°‚Üí", "!!!", "Œ£", "‚åí‚òÜ", "’û¬∞¬∑.", " ‚ô°", "Íï§*.Ôæü"],
			};

			const inputsContainer = document.getElementById("generator-inputs");
			const preview = document.querySelector("#kaomoji-preview pre");
			/* const btnCopy = document.getElementById("copy-generated"); */

			const parts = {}; // stores select references

			// Creates selects
			Object.entries(options).forEach(([part, values]) => {
				const label = document.createElement("label");
				label.textContent = part + ": ";

				const select = document.createElement("select");
				values.forEach((val, index) => {
					const option = document.createElement("option");
					option.value = val;
					option.textContent = index + 1 + ". " + (val || "(empty)"); // number for visualization
					select.appendChild(option);
				});

				parts[part] = select;
				label.appendChild(select);
				inputsContainer.appendChild(label);
				inputsContainer.appendChild(document.createElement("br"));
			});

			// Updates preview according to selection
			function updateKaomoji() {
				const kaomoji = `${parts.extraLeft.value}${parts.armLeft.value}${parts.faceLeft.value}${parts.eyeLeft.value}${parts.mouth.value}${parts.eyeRight.value}${parts.faceRight.value}${parts.armRight.value}${parts.extraRight.value}`;
				preview.textContent = kaomoji;
			}

			// Observes changes in selects
			Object.values(parts).forEach((sel) => sel.addEventListener("change", updateKaomoji));

			// Copy
			/* btnCopy.addEventListener("click", () => {
              navigator.clipboard.writeText(preview.textContent).then(() => {
                btnCopy.textContent = "Copied!";
                setTimeout(() => (btnCopy.textContent = "Copy Kaomoji"), 2000);
              });
            }); */

			const btnRandom = document.getElementById("generate-random");
			let slotMachineActive = true;

			const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
			let tickBuffer = null;
			let copySuccessBuffer = null;
			let copyFailBuffer = null;

			async function loadTickBuffer(url) {
				try {
					const res = await fetch(url);
					const arr = await res.arrayBuffer();
					tickBuffer = await audioCtx.decodeAudioData(arr);
				} catch (err) {
					console.warn("Failed to load tick audio:", err);
					tickBuffer = null;
				}
			}

			async function loadCopySuccessBuffer(url) {
				try {
					const res = await fetch(url);
					const arr = await res.arrayBuffer();
					copySuccessBuffer = await audioCtx.decodeAudioData(arr);
				} catch (err) {
					console.warn("Failed to load copy success audio:", err);
					copySuccessBuffer = null;
				}
			}

			async function loadCopyFailBuffer(url) {
				try {
					const res = await fetch(url);
					const arr = await res.arrayBuffer();
					copyFailBuffer = await audioCtx.decodeAudioData(arr);
				} catch (err) {
					console.warn("Failed to load copy fail audio:", err);
					copyFailBuffer = null;
				}
			}

			loadTickBuffer("/assets/wav/random_tick.wav");
			loadCopySuccessBuffer("/assets/wav/copy_success.wav");
			loadCopyFailBuffer("/assets/wav/copy_fail.wav");

			function playTick(volume = 0.55) {
				if (!tickBuffer) return;
				if (audioCtx.state === "suspended") {
					audioCtx.resume().catch(() => {});
				}

				const src = audioCtx.createBufferSource();
				src.buffer = tickBuffer;

				const gain = audioCtx.createGain();
				gain.gain.value = 0.0001;

				src.connect(gain).connect(audioCtx.destination);

				const now = audioCtx.currentTime;
				// quick attack to smooth and avoid clicks, with short decay
				gain.gain.setValueAtTime(0.0001, now);
				gain.gain.exponentialRampToValueAtTime(Math.max(0.001, volume), now + 0.001);
				gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.12);

				src.start(now);
				src.stop(now + tickBuffer.duration + 0.02);
			}

			function playCopySuccess(volume = 0.4) {
				if (!copySuccessBuffer) return;
				if (audioCtx.state === "suspended") {
					audioCtx.resume().catch(() => {});
				}

				const src = audioCtx.createBufferSource();
				src.buffer = copySuccessBuffer;

				const gain = audioCtx.createGain();
				gain.gain.value = 0.0001;

				src.connect(gain).connect(audioCtx.destination);

				const now = audioCtx.currentTime;
				// smooth attack and decay for success sound
				gain.gain.setValueAtTime(0.0001, now);
				gain.gain.exponentialRampToValueAtTime(Math.max(0.001, volume), now + 0.01);
				gain.gain.exponentialRampToValueAtTime(0.0001, now + copySuccessBuffer.duration);

				src.start(now);
				src.stop(now + copySuccessBuffer.duration + 0.02);
			}

			function playCopyFail(volume = 0.5) {
				if (!copyFailBuffer) return;
				if (audioCtx.state === "suspended") {
					audioCtx.resume().catch(() => {});
				}

				const src = audioCtx.createBufferSource();
				src.buffer = copyFailBuffer;

				const gain = audioCtx.createGain();
				gain.gain.value = 0.0001;

				src.connect(gain).connect(audioCtx.destination);

				const now = audioCtx.currentTime;
				// error sound with more abrupt attack
				gain.gain.setValueAtTime(0.0001, now);
				gain.gain.exponentialRampToValueAtTime(Math.max(0.001, volume), now + 0.005);
				gain.gain.exponentialRampToValueAtTime(0.0001, now + copyFailBuffer.duration);

				src.start(now);
				src.stop(now + copyFailBuffer.duration + 0.02);
			}

			function animateOrChange(select, targetIndex, callback) {
				if (slotMachineActive) {
					animatePart(select, targetIndex, callback);
				} else {
					select.selectedIndex = targetIndex;
					updateKaomoji();
					if (callback) callback();
				}
			}

			function animatePart(select, targetIndex, callback) {
				let current = select.selectedIndex;
				let step = targetIndex > current ? 1 : -1;
				let diff = Math.abs(targetIndex - current);
				let i = 0;
				let delay = 20;

				function frame() {
					current += step;
					if (current < 0) current = select.options.length - 1;
					if (current >= select.options.length) current = 0;

					select.selectedIndex = current;
					updateKaomoji();
					playTick();

					i++;
					if (i < diff) {
						delay += 5; // slows down
						setTimeout(frame, delay);
					} else {
						select.selectedIndex = targetIndex;
						updateKaomoji();
						if (callback) callback();
					}
				}

				frame();
			}

			btnRandom.addEventListener("click", () => {
				const idxFace = Math.floor(Math.random() * options.faceLeft.length);
				const idxEye = Math.floor(Math.random() * options.eyeLeft.length);
				const idxMouth = Math.floor(Math.random() * options.mouth.length);
				const idxArmLeft = Math.floor(Math.random() * options.armLeft.length);
				const idxArmRight = Math.floor(Math.random() * options.armRight.length);
				let idxExtraLeft = Math.floor(Math.random() * options.extraLeft.length);
				let idxExtraRight = Math.floor(Math.random() * options.extraRight.length);

				// Synchronizes if any is 7 or 11
				if (idxExtraLeft === 6 || idxExtraRight === 6) {
					idxExtraLeft = idxExtraRight = 6;
				} else if (idxExtraLeft === 10 || idxExtraRight === 10) {
					idxExtraLeft = idxExtraRight = 10;
				}

				if (slotMachineActive) {
					// staggered animation
					animateOrChange(parts.faceLeft, idxFace);
					animateOrChange(parts.faceRight, idxFace);

					setTimeout(() => {
						animateOrChange(parts.eyeLeft, idxEye);
						animateOrChange(parts.eyeRight, idxEye);
					}, 200);

					setTimeout(() => {
						animateOrChange(parts.mouth, idxMouth);
					}, 400);

					setTimeout(() => {
						animateOrChange(parts.armLeft, idxArmLeft);
						animateOrChange(parts.armRight, idxArmRight);
					}, 600);

					setTimeout(() => {
						animateOrChange(parts.extraLeft, idxExtraLeft);
						animateOrChange(parts.extraRight, idxExtraRight);
					}, 800);
				} else {
					// changes everything at once
					parts.faceLeft.selectedIndex = idxFace;
					parts.faceRight.selectedIndex = idxFace;
					parts.eyeLeft.selectedIndex = idxEye;
					parts.eyeRight.selectedIndex = idxEye;
					parts.mouth.selectedIndex = idxMouth;
					parts.armLeft.selectedIndex = idxArmLeft;
					parts.armRight.selectedIndex = idxArmRight;
					parts.extraLeft.selectedIndex = idxExtraLeft;
					parts.extraRight.selectedIndex = idxExtraRight;
					updateKaomoji();
				}
			});

			updateKaomoji();
		</script>

		<script>
			// Preloader management
			window.addEventListener("load", function () {
				const preloader = document.getElementById("preloader");
				setTimeout(() => {
					preloader.classList.add("hidden");
					// Remove preloader from DOM after transition
					setTimeout(() => {
						preloader.remove();
					}, 500);
				}, 500); // Minimum loading time for better UX
			});
		</script>
	</body>
</html>
